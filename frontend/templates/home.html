{% extends "base.html" %}
{% block content %}


<style>
    .search-container {
        background-color: #FFF;
        position: relative;
        border-radius: 30px;
        padding: 3px 50px 3px 10px;
    }
    .search-box {
        background-color: transparent;
        outline: none;
        height: 35px;
        font-size: 15px;
        border: 0;
        width: 100%;
    }
    .search-button {
        position: absolute;
        right: 4px;
        top: 4px;
        background-color: #C00;
        border-radius: 50%;
        border: 0;
        color: #FFF;
        width: 35px;
        height: 35px;
        outline: 0;
    }

    .jumbotron{
        background-image: url("https://cdn.shopify.com/s/files/1/0898/4708/articles/Black_Friday_Header_FA.jpg?v=1572010345");
        background-size: cover;
    }


</style>

<div style="height:auto;" class="jumbotron">

    <div class="search-container">
            <input style="height: 40px;" name="search"  class="search-box" placeholder="Enter Product Name" id="source" />
            <div id="result"></div>
            <a onclick="btn_submit()" style="text-align: center; height: 45px; width: 45px;top: 0px;right: 0px;color: black;padding: 5px;background: #8df44c;" class="search-button">Go</a>
    </div>

    <div class="row" style="margin-top: 30px;">
        {%  raw  %}
                <div id="product-data"></div>
                <script id="product-template" type="text/x-handlebars-template">
                    <div class="wrapper" style="display: flex; width: 100%;flex-wrap: wrap;padding-left: 100px">
                        {{#each this  }}
                                <div  style="padding: 20px;width: 450px;" class="card-deck">
                                    <div class="card mb-5" style="border-radius: 30px">
                                        <img style="height: 300px; border-radius: 30px" height="300px" class="card-img-top img-fluid" src="{{this._source.imageURLs.[0]}}" alt="Card image cap">
                                        <div class="card-body">
                                            <h4 style="text-align: center" class="card-title">{{this._source.name}}</h4>
                                            <p class="card-text">{{this._source.categories}}</p>
                                            <button style="border-radius: 30px;" class="form-control btn btn-primary">View</button>
                                        </div>
                                    </div>
                                </div>
                        {{/each}}
                    </div>
                </script>
        {%  endraw    %}


    </div>
</div>


<script>
    const $source = document.querySelector('#source');
    const $result = document.querySelector('#result');

    const typeHandler = function(e) {
        $result.innerHTML = e.target.value;
        $.ajax({
            url: "/pipe",
            type : 'POST',
            cache: false,
            data:{'data': e.target.value},
            success: function(html)
            {
                var data = html.aggregations.auto_complete.buckets
                var _ = []
                $.each(data, (index, value)=>{
                    _.push(value.key)
                });
                $( "#source" ).autocomplete({
                    source: _
                });
            }
        });
    }

    $source.addEventListener('input', typeHandler) // register for oninput
    $source.addEventListener('propertychange', typeHandler) // for IE8

    function btn_submit()
    {
        sessionStorage.setItem('title', $("#source").val() );
        var search_val = $("#source").val()

        $.ajax({
            url: "/search",
            type : 'POST',
            cache: false,
            data:{
                'what': search_val
            },
            success: function(data)
            {

                console.log(data.result);
                var card = data.result.hits.hits
                var facets = data.result.aggregations
                console.log(facets);




                var templateScript = Handlebars.compile($('#product-template').html());
                $('#product-data').html(templateScript(card));

                var templateScript = Handlebars.compile($('#facets-template').html());
                $('#facets-data').html(templateScript(facets));

                console.log("DONE")


            }
        });
    }


    $( document ).ready(function() {
        var data = sessionStorage.getItem('title')
        $("#source").val(data);
    });

    Handlebars.registerHelper('facets_round_numbers', function (data) {
        if (!data) return '';
        var value = parseInt(data);
        var ret = value;

        if (value > 10000) ret = (Math.round(value / 1000) * 1000);
        if (value > 1000) ret = (Math.round(value / 100) * 100);
        else if (value > 10) ret = (Math.round(value / 10) * 10);

        var tem = null;

        if (ret <= 10)
        {
            tem = '1-9'
        };

        if (ret >= 11 && ret <= 99)
        {
            tem = '10-99'
        }

        if (ret >= 100 && ret <= 500)
        {
            tem = '100-499'
        }
        if (ret >= 500)
        {
            tem = '500+'
        }
        return tem;
    });

    Handlebars.registerHelper('int_format', function (data) {
        if (!data) return '';
        return parseInt(data);
    });

    Handlebars.registerHelper('if_cond', function (v1, operator, v2, options) {

        switch (operator) {
            case '==':
                return (v1 == v2) ? options.fn(this) : options.inverse(this);
            case '===':
                return (v1 === v2) ? options.fn(this) : options.inverse(this);
            case '!=':
                return (v1 != v2) ? options.fn(this) : options.inverse(this);
            case '!==':
                return (v1 !== v2) ? options.fn(this) : options.inverse(this);
            case '<':
                return (v1 < v2) ? options.fn(this) : options.inverse(this);
            case '<=':
                return (v1 <= v2) ? options.fn(this) : options.inverse(this);
            case '>':
                return (v1 > v2) ? options.fn(this) : options.inverse(this);
            case '>=':
                return (v1 >= v2) ? options.fn(this) : options.inverse(this);
            case '&&':
                return (v1 && v2) ? options.fn(this) : options.inverse(this);
            case '||':
                return (v1 || v2) ? options.fn(this) : options.inverse(this);
            default:
                return options.inverse(this);
        }
    });

    Handlebars.registerHelper('if_eq', function (a, b, opts) {
        if (a == b)
            return opts.fn(this);
        else
            return opts.inverse(this);
    });


</script>
{% endblock %}

